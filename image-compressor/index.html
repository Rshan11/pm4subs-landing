<!doctype html>
<html lang="en" class="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <!-- Preconnect for performance -->
        <link rel="preconnect" href="https://cdn.tailwindcss.com" />
        <link rel="preconnect" href="https://challenges.cloudflare.com" />
        <link rel="dns-prefetch" href="https://cdn.tailwindcss.com" />
        <link rel="dns-prefetch" href="https://challenges.cloudflare.com" />

        <title>Free Image Compressor for Contractors | PM4Subs</title>
        <meta
            name="description"
            content="Compress construction photos to target file sizes, generate social media kits, and create favicon packages. Free tool - everything processes in your browser."
        />
        <meta name="robots" content="index, follow" />
        <link rel="canonical" href="https://pm4subs.com/image-compressor/" />

        <!-- Open Graph -->
        <meta
            property="og:title"
            content="Free Image Compressor for Contractors | PM4Subs"
        />
        <meta
            property="og:description"
            content="Compress construction photos to target file sizes, generate social media kits, and create favicon packages. Free - runs in your browser."
        />
        <meta
            property="og:url"
            content="https://pm4subs.com/image-compressor/"
        />
        <meta property="og:type" content="website" />
        <meta
            property="og:image"
            content="https://pm4subs.com/screenshots/projects-dashboard.webp"
        />

        <!-- Twitter -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta
            name="twitter:title"
            content="Free Image Compressor for Contractors | PM4Subs"
        />
        <meta
            name="twitter:description"
            content="Compress construction photos to target file sizes, generate social media kits, and create favicon packages."
        />
        <meta
            name="twitter:image"
            content="https://pm4subs.com/screenshots/projects-dashboard.webp"
        />

        <!-- Tailwind CSS CDN -->
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: "class",
            };
        </script>

        <!-- Design System -->
        <link rel="stylesheet" href="../design-system.css" />

        <!-- Cloudflare Turnstile -->
        <script
            src="https://challenges.cloudflare.com/turnstile/v0/api.js"
            async
            defer
        ></script>

        <!-- Shared Header -->
        <script src="../shared-header.js"></script>

        <style>
            .drop-zone {
                border: 3px dashed rgba(100, 116, 139, 0.5);
                transition: all 0.2s;
            }
            .drop-zone:hover,
            .drop-zone.drag-over {
                border-color: rgb(59, 130, 246);
                background: rgba(59, 130, 246, 0.1);
            }
            .tab-btn {
                transition: all 0.2s;
            }
            .tab-btn.active {
                background: rgb(59, 130, 246);
                border-color: rgb(96, 165, 250);
                color: white;
            }
            .results-section {
                background: rgba(34, 197, 94, 0.1);
                border: 2px solid rgba(34, 197, 94, 0.3);
            }
        </style>
    </head>
    <body>
        <script>
            initHeader();
        </script>

        <!-- Main Content -->
        <main class="max-w-5xl mx-auto px-4 py-10">
            <!-- Header -->
            <div class="text-center mb-10">
                <h1 class="text-3xl font-bold mb-3">Image Compressor</h1>
                <p class="text-gray-400">
                    Compress photos, generate social media kits, and create
                    favicon packages. Everything runs in your browser.
                </p>
            </div>

            <!-- Tabs -->
            <div class="flex flex-wrap gap-2 mb-8">
                <button
                    onclick="setActiveTab('compress')"
                    class="tab-btn active px-5 py-4 rounded-lg text-left border-2 border-gray-700 bg-gray-800"
                    data-tab="compress"
                >
                    <div class="font-semibold">Compress</div>
                    <div class="text-xs opacity-70 mt-1">Target file size</div>
                </button>
                <button
                    onclick="setActiveTab('social')"
                    class="tab-btn px-5 py-4 rounded-lg text-left border-2 border-gray-700 bg-gray-800"
                    data-tab="social"
                >
                    <div class="font-semibold">Social Media Kit</div>
                    <div class="text-xs opacity-70 mt-1">All platforms</div>
                </button>
                <button
                    onclick="setActiveTab('favicon')"
                    class="tab-btn px-5 py-4 rounded-lg text-left border-2 border-gray-700 bg-gray-800"
                    data-tab="favicon"
                >
                    <div class="font-semibold">Favicon Package</div>
                    <div class="text-xs opacity-70 mt-1">Every size needed</div>
                </button>
                <button
                    onclick="setActiveTab('all')"
                    class="tab-btn px-5 py-4 rounded-lg text-left border-2 border-gray-700 bg-gray-800"
                    data-tab="all"
                >
                    <div class="font-semibold">Full Brand Kit</div>
                    <div class="text-xs opacity-70 mt-1">
                        Everything at once
                    </div>
                </button>
            </div>

            <!-- Settings Panel -->
            <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 mb-6">
                <div class="flex flex-wrap gap-8">
                    <div id="size-setting">
                        <label
                            class="block text-sm font-semibold mb-2 text-blue-400"
                        >
                            Target File Size (KB)
                        </label>
                        <div class="flex items-center gap-3">
                            <input
                                type="range"
                                id="targetSize"
                                min="20"
                                max="1000"
                                step="10"
                                value="60"
                                oninput="updateSizeDisplay()"
                                class="w-40 accent-blue-500"
                            />
                            <span
                                id="sizeDisplay"
                                class="bg-blue-600 text-white px-3 py-1 rounded font-bold text-sm min-w-[70px] text-center"
                            >
                                60 KB
                            </span>
                        </div>
                    </div>

                    <div>
                        <label
                            class="block text-sm font-semibold mb-2 text-blue-400"
                        >
                            Export Format
                        </label>
                        <select
                            id="exportFormat"
                            class="px-4 py-2 bg-gray-900 border border-gray-600 rounded-lg text-gray-100 text-sm focus:outline-none focus:border-blue-500"
                        >
                            <option value="jpeg">JPEG</option>
                            <option value="webp">WebP</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Drop Zone -->
            <div
                id="dropZone"
                class="drop-zone rounded-2xl p-16 text-center cursor-pointer mb-6"
                onclick="document.getElementById('fileInput').click()"
            >
                <input
                    type="file"
                    id="fileInput"
                    multiple
                    accept="image/*"
                    class="hidden"
                    onchange="handleFileSelect(event)"
                />
                <div id="dropIcon" class="text-5xl mb-4">üñºÔ∏è</div>
                <p class="text-lg font-semibold">Drop your images here</p>
                <p class="text-sm text-gray-400 mt-2">
                    or click to browse - JPG, PNG, WebP supported
                </p>
            </div>

            <!-- File List -->
            <div
                id="fileList"
                class="hidden bg-gray-800 border border-gray-700 rounded-xl p-5 mb-6"
            >
                <div class="flex justify-between items-center mb-4">
                    <h3 id="fileCount" class="font-semibold">
                        0 files selected
                    </h3>
                    <button
                        onclick="clearFiles()"
                        class="px-3 py-1.5 bg-red-500/20 border border-red-500/50 rounded-lg text-red-400 text-sm hover:bg-red-500/30"
                    >
                        Clear All
                    </button>
                </div>
                <div id="fileItems" class="flex flex-wrap gap-3"></div>
            </div>

            <!-- Process Button -->
            <button
                id="processBtn"
                onclick="processFiles()"
                class="hidden w-full py-5 rounded-xl text-lg font-bold mb-8 bg-blue-600 hover:bg-blue-500 text-white transition-all"
            >
                Process Images
            </button>

            <!-- Results -->
            <div id="results" class="hidden results-section rounded-2xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-green-400">
                        Processing Complete
                    </h2>
                    <button
                        onclick="downloadAll()"
                        class="px-6 py-3 bg-green-500 hover:bg-green-400 rounded-lg text-gray-900 font-bold flex items-center gap-2"
                    >
                        Download All (ZIP)
                    </button>
                </div>
                <div id="resultItems"></div>
            </div>

            <!-- Features Section -->
            <div class="mt-16 pt-10 border-t border-gray-800">
                <h2 class="text-center text-2xl font-bold mb-10 text-blue-400">
                    Built for Contractors
                </h2>
                <div
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
                >
                    <div
                        class="bg-gray-800 border border-gray-700 rounded-xl p-6"
                    >
                        <div class="text-3xl mb-3">üéØ</div>
                        <h3 class="font-bold mb-2">Target File Size</h3>
                        <p class="text-sm text-gray-400 leading-relaxed">
                            Set your max KB and we hit it. No more
                            compress-check-repeat.
                        </p>
                    </div>
                    <div
                        class="bg-gray-800 border border-gray-700 rounded-xl p-6"
                    >
                        <div class="text-3xl mb-3">üìÅ</div>
                        <h3 class="font-bold mb-2">Smart Rename</h3>
                        <p class="text-sm text-gray-400 leading-relaxed">
                            ProjectName_Date_001.jpg format. No more IMG_4392
                            chaos.
                        </p>
                    </div>
                    <div
                        class="bg-gray-800 border border-gray-700 rounded-xl p-6"
                    >
                        <div class="text-3xl mb-3">üì±</div>
                        <h3 class="font-bold mb-2">Social Media Ready</h3>
                        <p class="text-sm text-gray-400 leading-relaxed">
                            Facebook, Instagram, LinkedIn, Google Business - all
                            sizes in one click.
                        </p>
                    </div>
                    <div
                        class="bg-gray-800 border border-gray-700 rounded-xl p-6"
                    >
                        <div class="text-3xl mb-3">üåê</div>
                        <h3 class="font-bold mb-2">Favicon Package</h3>
                        <p class="text-sm text-gray-400 leading-relaxed">
                            Every size your website needs. Apple, Android,
                            browser - covered.
                        </p>
                    </div>
                    <div
                        class="bg-gray-800 border border-gray-700 rounded-xl p-6"
                    >
                        <div class="text-3xl mb-3">üîí</div>
                        <h3 class="font-bold mb-2">Private</h3>
                        <p class="text-sm text-gray-400 leading-relaxed">
                            Everything processes in your browser. Your photos
                            never leave your device.
                        </p>
                    </div>
                    <div
                        class="bg-gray-800 border border-gray-700 rounded-xl p-6"
                    >
                        <div class="text-3xl mb-3">‚ö°</div>
                        <h3 class="font-bold mb-2">Fast</h3>
                        <p class="text-sm text-gray-400 leading-relaxed">
                            No upload wait. No server queue. Instant results.
                        </p>
                    </div>
                </div>
            </div>
        </main>

        <!-- CTA Section -->
        <section class="cta-section">
            <div class="container">
                <h2>Need to organize all these photos by project?</h2>
                <p>
                    PM4Subs helps masonry contractors manage projects, photos,
                    submittals, and crews.
                </p>
                <button class="btn-primary btn-lg" onclick="showEmailModal()">
                    Learn More About PM4Subs
                </button>
            </div>
        </section>

        <!-- Modal -->
        <div
            id="emailModal"
            class="modal-overlay"
            onclick="closeModalOnOverlay(event)"
        >
            <div class="modal-content" onclick="event.stopPropagation()">
                <button class="modal-close" onclick="closeEmailModal()">
                    &times;
                </button>
                <h3 class="modal-title">Request Early Access</h3>
                <form id="waitlistForm2" onsubmit="handleModalSubmit(event)">
                    <div class="form-group">
                        <label class="form-label" for="modalName"
                            >Full Name</label
                        >
                        <input
                            class="form-input"
                            type="text"
                            id="modalName"
                            name="name"
                            required
                            placeholder="John Smith"
                        />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="modalEmail"
                            >Email Address</label
                        >
                        <input
                            class="form-input"
                            type="email"
                            id="modalEmail"
                            name="email"
                            required
                            placeholder="john@company.com"
                        />
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="modalCompany"
                            >Company Name (Optional)</label
                        >
                        <input
                            class="form-input"
                            type="text"
                            id="modalCompany"
                            name="company"
                            placeholder="Your Company"
                        />
                    </div>
                    <button type="submit" class="btn-primary w-full">
                        Request Access
                    </button>
                    <div id="modalSuccessMessage" class="success-message">
                        Thanks! We'll be in touch soon.
                    </div>
                    <p class="form-note">
                        We'll personally reach out with your invite link
                    </p>
                </form>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <div class="container">
                <p>
                    &copy; 2026 PM4Subs. All rights reserved. |
                    <a href="/privacy/">Privacy Policy</a>
                </p>
                <p class="mt-2">
                    Questions?
                    <a href="mailto:hello@pm4subs.com">hello@pm4subs.com</a>
                </p>
                <p class="mt-2">
                    <a href="/"
                        >Back to PM4Subs project management for
                        subcontractors</a
                    >
                </p>
            </div>
        </footer>

        <!-- JSZip for download -->
        <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

        <script>
            // State
            let files = [];
            let activeTab = "compress";
            let results = [];

            const socialMediaSizes = [
                {
                    name: "Facebook Cover",
                    width: 820,
                    height: 312,
                    key: "fb-cover",
                },
                {
                    name: "Instagram Post",
                    width: 1080,
                    height: 1080,
                    key: "ig-post",
                },
                {
                    name: "LinkedIn Banner",
                    width: 1584,
                    height: 396,
                    key: "li-banner",
                },
                {
                    name: "Google Business",
                    width: 720,
                    height: 720,
                    key: "google-biz",
                },
                {
                    name: "Email Signature",
                    width: 200,
                    height: 80,
                    key: "email-sig",
                },
            ];

            const faviconSizes = [
                { size: 16, name: "favicon-16x16.png" },
                { size: 32, name: "favicon-32x32.png" },
                { size: 48, name: "favicon-48x48.png" },
                { size: 180, name: "apple-touch-icon.png" },
                { size: 192, name: "android-chrome-192x192.png" },
                { size: 512, name: "android-chrome-512x512.png" },
            ];

            function showEmailModal() {
                document.getElementById("emailModal").classList.add("show");
            }

            function closeEmailModal() {
                document.getElementById("emailModal").classList.remove("show");
            }

            function closeModalOnOverlay(event) {
                if (event.target.id === "emailModal") {
                    closeEmailModal();
                }
            }

            async function handleModalSubmit(event) {
                event.preventDefault();
                const submitBtn = event.target.querySelector(
                    'button[type="submit"]',
                );
                const originalText = submitBtn.textContent;
                submitBtn.textContent = "Submitting...";
                submitBtn.disabled = true;

                const name = document.getElementById("modalName").value;
                const email = document.getElementById("modalEmail").value;
                const company = document.getElementById("modalCompany").value;

                try {
                    const response = await fetch(
                        "https://muxjcyckyxviqjpmvcri.supabase.co/functions/v1/waitlist-signup",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                apikey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11eGpjeWNreXh2aXFqcG12Y3JpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDEyMjUsImV4cCI6MjA3NDkxNzIyNX0.GAJomF8rZcrLSQljl6-Imjcv1wKhNxW4AT10V-zURls",
                                Authorization:
                                    "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11eGpjeWNreXh2aXFqcG12Y3JpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDEyMjUsImV4cCI6MjA3NDkxNzIyNX0.GAJomF8rZcrLSQljl6-Imjcv1wKhNxW4AT10V-zURls",
                            },
                            body: JSON.stringify({
                                name,
                                email,
                                company,
                                source: "Image Compressor Page",
                            }),
                        },
                    );
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById(
                            "modalSuccessMessage",
                        ).style.display = "block";
                        document.getElementById("waitlistForm2").reset();
                        setTimeout(() => {
                            closeEmailModal();
                            document.getElementById(
                                "modalSuccessMessage",
                            ).style.display = "none";
                        }, 2000);
                    } else {
                        alert(
                            data.error ||
                                "Something went wrong. Please try again.",
                        );
                    }
                } catch (error) {
                    console.error("Submission error:", error);
                    alert(
                        "Something went wrong. Please try again or email us at hello@pm4subs.com",
                    );
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }

            // Tab switching
            function setActiveTab(tab) {
                activeTab = tab;
                document.querySelectorAll(".tab-btn").forEach((btn) => {
                    btn.classList.toggle("active", btn.dataset.tab === tab);
                });

                // Show/hide size setting based on tab
                const sizeSetting = document.getElementById("size-setting");
                if (tab === "compress" || tab === "all") {
                    sizeSetting.style.display = "block";
                } else {
                    sizeSetting.style.display = "none";
                }
            }

            // Size slider
            function updateSizeDisplay() {
                const value = document.getElementById("targetSize").value;
                document.getElementById("sizeDisplay").textContent =
                    value + " KB";
            }

            // Drag and drop
            const dropZone = document.getElementById("dropZone");

            dropZone.addEventListener("dragover", (e) => {
                e.preventDefault();
                dropZone.classList.add("drag-over");
                document.getElementById("dropIcon").textContent = "üì•";
            });

            dropZone.addEventListener("dragleave", () => {
                dropZone.classList.remove("drag-over");
                document.getElementById("dropIcon").textContent = "üñºÔ∏è";
            });

            dropZone.addEventListener("drop", (e) => {
                e.preventDefault();
                dropZone.classList.remove("drag-over");
                document.getElementById("dropIcon").textContent = "üñºÔ∏è";

                const droppedFiles = Array.from(e.dataTransfer.files).filter(
                    (f) => f.type.startsWith("image/"),
                );
                files = [...files, ...droppedFiles];
                updateFileList();
            });

            // File selection
            function handleFileSelect(e) {
                const selectedFiles = Array.from(e.target.files);
                files = [...files, ...selectedFiles];
                updateFileList();
            }

            function updateFileList() {
                const fileList = document.getElementById("fileList");
                const fileItems = document.getElementById("fileItems");
                const fileCount = document.getElementById("fileCount");
                const processBtn = document.getElementById("processBtn");

                if (files.length === 0) {
                    fileList.classList.add("hidden");
                    processBtn.classList.add("hidden");
                    return;
                }

                fileList.classList.remove("hidden");
                processBtn.classList.remove("hidden");
                fileCount.textContent = `${files.length} file${files.length > 1 ? "s" : ""} selected`;
                processBtn.textContent = `Process ${files.length} Image${files.length > 1 ? "s" : ""}`;

                fileItems.innerHTML = files
                    .map(
                        (file, idx) => `
                <div class="bg-gray-900 rounded-lg p-3 flex items-center gap-3">
                    <img src="${URL.createObjectURL(file)}" alt="" class="w-12 h-12 object-cover rounded">
                    <div>
                        <div class="text-sm font-medium max-w-[150px] truncate">${file.name}</div>
                        <div class="text-xs text-gray-400">${formatBytes(file.size)}</div>
                    </div>
                    <button onclick="removeFile(${idx})" class="text-red-400 hover:text-red-300 text-xl px-1">&times;</button>
                </div>
            `,
                    )
                    .join("");
            }

            function removeFile(index) {
                files = files.filter((_, i) => i !== index);
                updateFileList();
            }

            function clearFiles() {
                files = [];
                updateFileList();
                document.getElementById("results").classList.add("hidden");
            }

            // Image processing
            function compressImage(file, maxSizeKB, format = "jpeg") {
                return new Promise((resolve) => {
                    const img = new Image();
                    const mimeType =
                        format === "webp" ? "image/webp" : "image/jpeg";

                    img.onload = () => {
                        // Binary search for optimal quality at given scale
                        const findOptimalQuality = (
                            canvas,
                            minQ,
                            maxQ,
                            callback,
                        ) => {
                            if (maxQ - minQ < 0.02) {
                                // Close enough, use minQ to ensure we're under target
                                canvas.toBlob(
                                    (blob) => callback(blob, minQ),
                                    mimeType,
                                    minQ,
                                );
                                return;
                            }

                            const midQ = (minQ + maxQ) / 2;
                            canvas.toBlob(
                                (blob) => {
                                    if (blob.size / 1024 <= maxSizeKB) {
                                        // Under target, try higher quality
                                        findOptimalQuality(
                                            canvas,
                                            midQ,
                                            maxQ,
                                            callback,
                                        );
                                    } else {
                                        // Over target, try lower quality
                                        findOptimalQuality(
                                            canvas,
                                            minQ,
                                            midQ,
                                            callback,
                                        );
                                    }
                                },
                                mimeType,
                                midQ,
                            );
                        };

                        const tryCompressAtScale = (scale) => {
                            const canvas = document.createElement("canvas");
                            const ctx = canvas.getContext("2d");

                            canvas.width = Math.round(img.width * scale);
                            canvas.height = Math.round(img.height * scale);
                            ctx.drawImage(
                                img,
                                0,
                                0,
                                canvas.width,
                                canvas.height,
                            );

                            // First check if minimum quality at this scale works
                            canvas.toBlob(
                                (minBlob) => {
                                    if (minBlob.size / 1024 <= maxSizeKB) {
                                        // Can hit target at this scale, find optimal quality
                                        findOptimalQuality(
                                            canvas,
                                            0.1,
                                            0.95,
                                            (blob, quality) => {
                                                resolve({
                                                    blob,
                                                    quality: quality,
                                                    scale: scale,
                                                    originalSize: file.size,
                                                    newSize: blob.size,
                                                    format: format,
                                                });
                                            },
                                        );
                                    } else if (scale > 0.05) {
                                        // Need to scale down more
                                        tryCompressAtScale(scale * 0.7);
                                    } else {
                                        // Can't hit target, return best effort
                                        resolve({
                                            blob: minBlob,
                                            quality: 0.1,
                                            scale: scale,
                                            originalSize: file.size,
                                            newSize: minBlob.size,
                                            format: format,
                                        });
                                    }
                                },
                                mimeType,
                                0.1,
                            );
                        };

                        tryCompressAtScale(1);
                    };

                    img.src = URL.createObjectURL(file);
                });
            }

            function resizeImage(file, width, height, cover = true) {
                return new Promise((resolve) => {
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");
                    const img = new Image();

                    img.onload = () => {
                        canvas.width = width;
                        canvas.height = height;

                        if (cover) {
                            const scale = Math.max(
                                width / img.width,
                                height / img.height,
                            );
                            const x = (width - img.width * scale) / 2;
                            const y = (height - img.height * scale) / 2;
                            ctx.drawImage(
                                img,
                                x,
                                y,
                                img.width * scale,
                                img.height * scale,
                            );
                        } else {
                            const scale = Math.min(
                                width / img.width,
                                height / img.height,
                            );
                            const x = (width - img.width * scale) / 2;
                            const y = (height - img.height * scale) / 2;
                            ctx.fillStyle = "transparent";
                            ctx.fillRect(0, 0, width, height);
                            ctx.drawImage(
                                img,
                                x,
                                y,
                                img.width * scale,
                                img.height * scale,
                            );
                        }

                        canvas.toBlob(
                            (blob) => {
                                resolve(blob);
                            },
                            "image/png",
                            0.95,
                        );
                    };

                    img.src = URL.createObjectURL(file);
                });
            }

            async function generateFavicons(file) {
                const results = [];
                for (const { size, name } of faviconSizes) {
                    const blob = await resizeImage(file, size, size, false);
                    results.push({ name, blob, size: `${size}x${size}` });
                }
                return results;
            }

            function resizeImageWebP(file, width, height, cover = true) {
                return new Promise((resolve) => {
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");
                    const img = new Image();

                    img.onload = () => {
                        canvas.width = width;
                        canvas.height = height;

                        if (cover) {
                            const scale = Math.max(
                                width / img.width,
                                height / img.height,
                            );
                            const x = (width - img.width * scale) / 2;
                            const y = (height - img.height * scale) / 2;
                            ctx.drawImage(
                                img,
                                x,
                                y,
                                img.width * scale,
                                img.height * scale,
                            );
                        } else {
                            const scale = Math.min(
                                width / img.width,
                                height / img.height,
                            );
                            const x = (width - img.width * scale) / 2;
                            const y = (height - img.height * scale) / 2;
                            ctx.fillStyle = "transparent";
                            ctx.fillRect(0, 0, width, height);
                            ctx.drawImage(
                                img,
                                x,
                                y,
                                img.width * scale,
                                img.height * scale,
                            );
                        }

                        canvas.toBlob(
                            (blob) => {
                                resolve(blob);
                            },
                            "image/webp",
                            0.9,
                        );
                    };

                    img.src = URL.createObjectURL(file);
                });
            }

            async function generateSocialMedia(file) {
                const results = [];
                for (const { name, width, height, key } of socialMediaSizes) {
                    const blob = await resizeImageWebP(
                        file,
                        width,
                        height,
                        true,
                    );
                    results.push({
                        name,
                        blob,
                        dimensions: `${width}x${height}`,
                        key,
                    });
                }
                return results;
            }

            async function processFiles() {
                if (files.length === 0) return;

                const processBtn = document.getElementById("processBtn");
                processBtn.disabled = true;
                processBtn.classList.add(
                    "bg-gray-700",
                    "text-gray-400",
                    "cursor-not-allowed",
                );
                processBtn.classList.remove("bg-blue-600", "hover:bg-blue-500");
                processBtn.textContent = "Processing...";

                const targetSize = parseInt(
                    document.getElementById("targetSize").value,
                );

                results = [];

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const result = { original: file, outputs: {} };

                    if (activeTab === "compress" || activeTab === "all") {
                        const exportFormat =
                            document.getElementById("exportFormat").value;
                        const compressed = await compressImage(
                            file,
                            targetSize,
                            exportFormat,
                        );
                        const ext = exportFormat === "webp" ? "webp" : "jpg";
                        const baseName = file.name.replace(/\.[^/.]+$/, "");
                        const newName = `${baseName}.${ext}`;
                        result.outputs.compressed = {
                            ...compressed,
                            name: newName,
                        };
                    }

                    if (activeTab === "social" || activeTab === "all") {
                        result.outputs.social = await generateSocialMedia(file);
                    }

                    if (activeTab === "favicon" || activeTab === "all") {
                        result.outputs.favicons = await generateFavicons(file);
                    }

                    results.push(result);
                }

                displayResults();

                processBtn.disabled = false;
                processBtn.classList.remove(
                    "bg-gray-700",
                    "text-gray-400",
                    "cursor-not-allowed",
                );
                processBtn.classList.add("bg-blue-600", "hover:bg-blue-500");
                processBtn.textContent = `Process ${files.length} Image${files.length > 1 ? "s" : ""}`;
            }

            function displayResults() {
                const resultsDiv = document.getElementById("results");
                const resultItems = document.getElementById("resultItems");

                resultsDiv.classList.remove("hidden");

                resultItems.innerHTML = results
                    .map((result, idx) => {
                        let html = `<div class="bg-gray-900/50 rounded-xl p-5 mb-4">
                    <h3 class="font-semibold mb-4">${result.original.name}</h3>`;

                        if (result.outputs.compressed) {
                            const comp = result.outputs.compressed;
                            const reduction = Math.round(
                                (1 - comp.newSize / comp.originalSize) * 100,
                            );
                            html += `
                        <div class="mb-5">
                            <div class="text-sm font-semibold text-blue-400 mb-2">Compressed</div>
                            <div class="flex items-center gap-4 bg-gray-800 p-3 rounded-lg flex-wrap">
                                <span>${formatBytes(comp.originalSize)}</span>
                                <span class="text-green-400">‚Üí</span>
                                <span class="text-green-400 font-bold">${formatBytes(comp.newSize)}</span>
                                <span class="bg-green-500 text-gray-900 px-2 py-0.5 rounded text-xs font-bold">-${reduction}%</span>
                                <button onclick="downloadBlob(results[${idx}].outputs.compressed.blob, '${comp.name}')" class="ml-auto px-3 py-1.5 bg-blue-500/20 border border-blue-500 rounded-lg text-blue-400 text-sm hover:bg-blue-500/30">
                                    Download
                                </button>
                            </div>
                        </div>`;
                        }

                        if (result.outputs.social) {
                            html += `
                        <div class="mb-5">
                            <div class="text-sm font-semibold text-blue-400 mb-2">Social Media Kit</div>
                            <div class="flex flex-wrap gap-2">
                                ${result.outputs.social
                                    .map(
                                        (item, i) => `
                                    <button onclick="downloadBlob(results[${idx}].outputs.social[${i}].blob, '${item.key}.webp')" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm text-left hover:border-gray-600">
                                        <div class="font-medium">${item.name}</div>
                                        <div class="text-xs text-gray-400">${item.dimensions}</div>
                                    </button>
                                `,
                                    )
                                    .join("")}
                            </div>
                        </div>`;
                        }

                        if (result.outputs.favicons) {
                            html += `
                        <div>
                            <div class="text-sm font-semibold text-blue-400 mb-2">Favicon Package</div>
                            <div class="flex flex-wrap gap-2">
                                ${result.outputs.favicons
                                    .map(
                                        (item, i) => `
                                    <button onclick="downloadBlob(results[${idx}].outputs.favicons[${i}].blob, '${item.name}')" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm text-left hover:border-gray-600">
                                        <div class="font-medium">${item.size}</div>
                                        <div class="text-xs text-gray-400">${item.name}</div>
                                    </button>
                                `,
                                    )
                                    .join("")}
                            </div>
                        </div>`;
                        }

                        html += "</div>";
                        return html;
                    })
                    .join("");
            }

            function downloadBlob(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }

            async function downloadAll() {
                const zip = new JSZip();

                results.forEach((result) => {
                    if (result.outputs.compressed) {
                        zip.file(
                            result.outputs.compressed.name,
                            result.outputs.compressed.blob,
                        );
                    }

                    if (result.outputs.social) {
                        const baseName = result.original.name.replace(
                            /\.[^/.]+$/,
                            "",
                        );
                        const socialFolder = zip.folder(`${baseName}-social`);
                        result.outputs.social.forEach((item) => {
                            socialFolder.file(`${item.key}.webp`, item.blob);
                        });
                    }

                    if (result.outputs.favicons) {
                        const baseName = result.original.name.replace(
                            /\.[^/.]+$/,
                            "",
                        );
                        const faviconFolder = zip.folder(
                            `${baseName}-favicons`,
                        );
                        result.outputs.favicons.forEach((item) => {
                            faviconFolder.file(item.name, item.blob);
                        });
                    }
                });

                const content = await zip.generateAsync({ type: "blob" });
                downloadBlob(content, "images.zip");
            }

            function formatBytes(bytes) {
                if (bytes < 1024) return bytes + " B";
                if (bytes < 1024 * 1024)
                    return (bytes / 1024).toFixed(1) + " KB";
                return (bytes / (1024 * 1024)).toFixed(1) + " MB";
            }
        </script>
    </body>
</html>
